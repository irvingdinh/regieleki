<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Regieleki DNS</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0d1117;color:#c9d1d9;min-height:100vh}
.c{max-width:860px;margin:0 auto;padding:24px 16px}
h1{font-size:1.4rem;margin-bottom:24px;color:#58a6ff;font-weight:600;letter-spacing:-0.02em}
h1 span{color:#8b949e;font-weight:400;font-size:0.85rem;margin-left:8px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.header h1{margin-bottom:0}
.logout{color:#8b949e;font-size:12px;cursor:pointer;background:none;border:1px solid #30363d;padding:4px 10px;border-radius:6px}
.logout:hover{color:#f85149;border-color:#f8514933}
.form{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.form input,.form select{background:#161b22;border:1px solid #30363d;color:#c9d1d9;padding:8px 12px;border-radius:6px;font-size:14px;outline:none;transition:border-color .15s}
.form input:focus,.form select:focus{border-color:#58a6ff}
.form input[name=domain]{flex:2;min-width:160px}
.form input[name=value]{flex:2;min-width:160px}
.form select{min-width:90px}
.btn{border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:background .15s}
.btn-add{background:#238636;color:#fff}
.btn-add:hover{background:#2ea043}
.btn-edit{background:#1f6feb;color:#fff;padding:4px 10px;font-size:12px}
.btn-edit:hover{background:#388bfd}
.btn-del{background:transparent;color:#f85149;border:1px solid #f8514933;padding:4px 10px;font-size:12px}
.btn-del:hover{background:#f8514922}
.btn-cancel{background:#30363d;color:#c9d1d9;margin-left:4px}
.btn-cancel:hover{background:#484f58}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #21262d}
th{color:#8b949e;font-weight:500;font-size:12px;text-transform:uppercase;letter-spacing:0.05em}
td{font-size:14px}
.mono{font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:13px}
.badge{display:inline-block;background:#1f6feb22;color:#58a6ff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;letter-spacing:0.03em}
.actions{display:flex;gap:6px;justify-content:flex-end}
.empty{text-align:center;color:#484f58;padding:48px 16px;font-size:14px}
.toast{position:fixed;bottom:20px;right:20px;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:500;opacity:0;transition:opacity .3s;pointer-events:none;z-index:99}
.toast.ok{background:#238636;color:#fff}
.toast.err{background:#da3633;color:#fff}
.toast.show{opacity:1}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100}
.overlay.hidden{display:none}
.auth-box{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:32px;max-width:380px;width:100%}
.auth-box h2{color:#58a6ff;font-size:1.1rem;margin-bottom:8px}
.auth-box p{color:#8b949e;font-size:13px;margin-bottom:16px}
.auth-box input{width:100%;background:#0d1117;border:1px solid #30363d;color:#c9d1d9;padding:10px 12px;border-radius:6px;font-size:14px;font-family:inherit;outline:none;margin-bottom:12px}
.auth-box input:focus{border-color:#58a6ff}
.auth-box button{width:100%;background:#238636;color:#fff;border:none;padding:10px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer}
.auth-box button:hover{background:#2ea043}
.auth-box .err-msg{color:#f85149;font-size:12px;margin-bottom:8px;display:none}
@media(max-width:600px){.form{flex-direction:column}.form input,.form select{width:100%}}
</style>
</head>
<body>
<div class="c">
  <div class="header">
    <h1>&#9889; Regieleki<span>DNS Manager</span></h1>
    <button class="logout" id="logoutBtn">Logout</button>
  </div>
  <form class="form" id="form" autocomplete="off">
    <input name="domain" placeholder="Domain (e.g. app.my.local)" required>
    <select name="type">
      <option value="A">A</option>
      <option value="AAAA">AAAA</option>
      <option value="CNAME">CNAME</option>
    </select>
    <input name="value" placeholder="Value (e.g. 100.70.30.1)" required>
    <button type="submit" class="btn btn-add" id="sbtn">Add</button>
    <button type="button" class="btn btn-cancel" id="cbtn" style="display:none">Cancel</button>
  </form>
  <table>
    <thead><tr><th>Domain</th><th>Type</th><th>Value</th><th style="text-align:right">Actions</th></tr></thead>
    <tbody id="tb"></tbody>
  </table>
  <div id="empty" class="empty" style="display:none">No custom DNS records yet. Add one above.</div>
</div>
<div class="overlay hidden" id="authOverlay">
  <div class="auth-box">
    <h2>Access Token</h2>
    <p>Run <code>regieleki access-token</code> on your server to get the token.</p>
    <div class="err-msg" id="authErr">Invalid token</div>
    <input type="password" id="tokenInput" placeholder="Paste your access token">
    <button id="tokenSave">Continue</button>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>
const $ = s => document.querySelector(s);
const tb = $('#tb'), empty = $('#empty'), form = $('#form'), sbtn = $('#sbtn'), cbtn = $('#cbtn'), toast = $('#toast');
const authOverlay = $('#authOverlay'), tokenInput = $('#tokenInput'), tokenSave = $('#tokenSave'), authErr = $('#authErr');
let editId = null, toastTimer;

function getToken() { return localStorage.getItem('regieleki_token') || ''; }
function setToken(t) { localStorage.setItem('regieleki_token', t); }

function showAuth() {
  authOverlay.classList.remove('hidden');
  authErr.style.display = 'none';
  tokenInput.value = '';
  tokenInput.focus();
}

function hideAuth() {
  authOverlay.classList.add('hidden');
}

async function api(url, opts = {}) {
  opts.headers = Object.assign({'Authorization': 'Bearer ' + getToken()}, opts.headers || {});
  const r = await fetch(url, opts);
  if (r.status === 401) {
    showAuth();
    throw new Error('unauthorized');
  }
  return r;
}

tokenSave.addEventListener('click', async () => {
  const t = tokenInput.value.trim();
  if (!t) return;
  setToken(t);
  try {
    const r = await api('/api/records');
    if (r.ok) {
      hideAuth();
      load();
    }
  } catch(e) {
    authErr.style.display = '';
  }
});

tokenInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') tokenSave.click();
});

$('#logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('regieleki_token');
  showAuth();
});

function notify(msg, ok) {
  toast.textContent = msg;
  toast.className = 'toast ' + (ok ? 'ok' : 'err') + ' show';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 2000);
}

async function load() {
  try {
    const r = await api('/api/records');
    const data = await r.json();
    tb.innerHTML = '';
    if (!data || data.length === 0) {
      empty.style.display = '';
      return;
    }
    empty.style.display = 'none';
    data.forEach(rec => {
      const tr = document.createElement('tr');

      const tdDomain = document.createElement('td');
      tdDomain.className = 'mono';
      tdDomain.textContent = rec.domain;

      const tdType = document.createElement('td');
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = rec.type;
      tdType.appendChild(badge);

      const tdValue = document.createElement('td');
      tdValue.className = 'mono';
      tdValue.textContent = rec.value;

      const tdActions = document.createElement('td');
      tdActions.className = 'actions';

      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-edit';
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', () => editRec(rec.id, rec.domain, rec.type, rec.value));

      const delBtn = document.createElement('button');
      delBtn.className = 'btn btn-del';
      delBtn.textContent = 'Delete';
      delBtn.addEventListener('click', () => delRec(rec.id));

      tdActions.appendChild(editBtn);
      tdActions.appendChild(delBtn);

      tr.appendChild(tdDomain);
      tr.appendChild(tdType);
      tr.appendChild(tdValue);
      tr.appendChild(tdActions);

      tb.appendChild(tr);
    });
  } catch(e) {
    if (e.message !== 'unauthorized') notify('Failed to load records', false);
  }
}

function editRec(id, domain, rtype, value) {
  editId = id;
  form.domain.value = domain;
  form.type.value = rtype;
  form.value.value = value;
  sbtn.textContent = 'Update';
  cbtn.style.display = '';
  form.domain.focus();
}

function cancelEdit() {
  editId = null;
  form.reset();
  sbtn.textContent = 'Add';
  cbtn.style.display = 'none';
}

cbtn.addEventListener('click', cancelEdit);

form.addEventListener('submit', async e => {
  e.preventDefault();
  const body = JSON.stringify({
    domain: form.domain.value.trim(),
    type: form.type.value,
    value: form.value.value.trim()
  });
  const hdr = {'Content-Type': 'application/json'};
  try {
    let r;
    if (editId) {
      r = await api('/api/records/' + editId, {method:'PUT', body, headers:hdr});
    } else {
      r = await api('/api/records', {method:'POST', body, headers:hdr});
    }
    if (!r.ok) {
      const d = await r.json().catch(() => ({}));
      notify(d.error || 'Request failed', false);
      return;
    }
    notify(editId ? 'Record updated' : 'Record added', true);
    cancelEdit();
    load();
  } catch(e) {
    if (e.message !== 'unauthorized') notify('Network error', false);
  }
});

async function delRec(id) {
  if (!confirm('Delete this record?')) return;
  try {
    const r = await api('/api/records/' + id, {method:'DELETE'});
    if (!r.ok) {
      notify('Delete failed', false);
      return;
    }
    notify('Record deleted', true);
    load();
  } catch(e) {
    if (e.message !== 'unauthorized') notify('Network error', false);
  }
}

load();
</script>
</body>
</html>
